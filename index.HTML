<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor La Malagueta - Particulares</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .nav-button.active {
            background-color: #4F46E5; /* indigo-600 */
            color: white;
        }
        .nav-button {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .view-transition {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); 
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 24px; 
            border: 1px solid #e2e8f0; 
            width: 90%;   
            max-width: 500px; 
            border-radius: 0.5rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content input[type="text"],
        .modal-content input[type="tel"],
        .modal-content input[type="email"],
        .modal-content textarea {
            width: 100%;
            padding: 0.75rem; 
            border: 1px solid #D1D5DB; 
            border-radius: 0.375rem; 
            box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
        }
        .modal-content input:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: #4F46E5; 
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5); 
        }
        /* Estilo para input deshabilitado (autocompletado) */
        input:disabled, textarea:disabled {
            background-color: #f3f4f6; /* Tailwind gray-100 */
            color: #6b7280; /* Tailwind gray-500 */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <header class="bg-indigo-700 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-semibold">La Malagueta Limpieza</h1>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4 w-full">
        <div id="viewCitas" class="view-section">
             <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Panel de Citas</h2>
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
                    <div class="relative w-full sm:w-1/2">
                        <input type="text" id="searchCitas" placeholder="Buscar por cliente, ticket..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                    <button onclick="showView('viewNuevaCita')" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i> Nueva Cita
                    </button>
                </div>
                <div id="citasList" class="overflow-x-auto">
                    </div>
            </div>
        </div>

        <div id="viewNuevaCita" class="view-section hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Crear Nueva Cita/Pedido</h2>
                <form id="formNuevaCita">
                    <div class="mb-6 border-b pb-4">
                        <h3 class="text-lg font-medium text-indigo-600 mb-3">Datos del Cliente</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="nc_telefonoCliente" class="block text-sm font-medium text-gray-700 mb-1">Teléfono Cliente (buscar/crear)</label>
                                <input type="tel" id="nc_telefonoCliente" name="Telefono_Cliente" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" required onblur="buscarClientePorTelefono(this.value)">
                            </div>
                            <div>
                                <label for="nc_nombreCliente" class="block text-sm font-medium text-gray-700 mb-1">Nombre Cliente</label>
                                <input type="text" id="nc_nombreCliente" name="Nombre_Cliente" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="nc_direccionCita" class="block text-sm font-medium text-gray-700 mb-1">Dirección del Servicio (Recogida/Entrega)</label>
                            <input type="text" id="nc_direccionCita" name="Direccion_Cita" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                         <div class="mt-4">
                            <label for="nc_emailCliente" class="block text-sm font-medium text-gray-700 mb-1">Email Cliente (Opcional)</label>
                            <input type="email" id="nc_emailCliente" name="Email" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="mt-4">
                            <label for="nc_notasCliente" class="block text-sm font-medium text-gray-700 mb-1">Notas Cliente (Opcional)</label>
                            <textarea id="nc_notasCliente" name="Notas_Cliente" rows="2" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                        <input type="hidden" id="nc_idCliente" name="ID_Cliente_FK">
                        <div id="clienteEncontradoMsg" class="mt-2 text-sm text-green-600"></div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-medium text-indigo-600 mb-3">Datos de la Cita/Pedido</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="nc_tipoCita" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cita</label>
                                <select id="nc_tipoCita" name="Tipo_Cita" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" required>
                                    <option value="Recogida">Recogida</option>
                                    <option value="Entrega">Entrega</option>
                                </select>
                            </div>
                            <div>
                                <label for="nc_fechaHoraCita" class="block text-sm font-medium text-gray-700 mb-1">Fecha y Hora</label>
                                <input type="datetime-local" id="nc_fechaHoraCita" name="Fecha_Hora_Cita" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" required onchange="actualizarDiaSemana('nc_fechaHoraCita', 'nc_diaSemana')">
                                <span id="nc_diaSemana" class="text-sm text-gray-600 ml-2"></span> </div>
                        </div>

                        <div class="mt-4">
                            <label for="nc_servicioPostRecogida" class="block text-sm font-medium text-gray-700 mb-1">Servicio Post-Recogida (si es Recogida)</label>
                            <select id="nc_servicioPostRecogida" name="Servicio_PostRecogida" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- Seleccionar servicio --</option>
                                <option value="Limpiar y Entregar Directamente">Limpiar y Entregar Directamente</option>
                                <option value="Almacenar (avisar para limpieza/entrega)">Almacenar (avisar para limpieza/entrega)</option>
                                <option value="Solo Limpiar (cliente recoge)">Solo Limpiar (cliente recoge)</option>
                                <option value="Otro (detallar en notas)">Otro (detallar en notas)</option>
                            </select>
                        </div>

                        <div class="mt-4">
                            <label for="nc_articulosDescripcion" class="block text-sm font-medium text-gray-700 mb-1">Descripción General de Artículos</label>
                            <textarea id="nc_articulosDescripcion" name="Articulos_Descripcion" rows="3" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" required placeholder="Ej: 2 alfombras salón, 1 edredón matrimonio"></textarea>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label for="nc_numeroTicket" class="block text-sm font-medium text-gray-700 mb-1">Número de Ticket</label>
                                <input type="text" id="nc_numeroTicket" name="Numero_Ticket" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" placeholder="Ej: 5001 (se sugiere auto)" required>
                            </div>
                            <div>
                                <label for="nc_precioTicket" class="block text-sm font-medium text-gray-700 mb-1">Precio Ticket (€) (Opcional inicial)</label>
                                <input type="number" step="0.01" id="nc_precioTicket" name="Precio_Ticket" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" placeholder="Se calculará/confirmará post-recogida">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label for="nc_estadoPedido" class="block text-sm font-medium text-gray-700 mb-1">Estado del Pedido (Inicial)</label>
                                <select id="nc_estadoPedido" name="Estado_Pedido" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" required>
                                    <option value="Pendiente Recogida" selected>Pendiente Recogida</option>
                                    <option value="Recogido/En Taller/Presupuesto">Recogido/En Taller/Presupuesto</option>
                                    <option value="En Almacén (Pendiente Limpieza)">En Almacén (Pendiente Limpieza)</option>
                                    <option value="Listo para Entrega">Listo para Entrega</option>
                                    <option value="Entregado">Entregado</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                            <div>
                                <label for="nc_ubicacionAlmacenCliente" class="block text-sm font-medium text-gray-700 mb-1">Ubicación en Almacén (Opcional)</label>
                                <input type="text" id="nc_ubicacionAlmacenCliente" name="Ubicacion_Almacen_Cliente" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" placeholder="Ej: Estantería A1">
                            </div>
                        </div>

                        <div class="mt-4">
                            <label for="nc_notasCita" class="block text-sm font-medium text-gray-700 mb-1">Notas Adicionales para la Cita (Opcional)</label>
                            <textarea id="nc_notasCita" name="Notas_Cita" rows="2" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="showView('viewCitas')" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out">
                            Cancelar
                        </button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105">
                            <i class="fas fa-save mr-2"></i> Guardar Cita
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="viewClientes" class="view-section hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Gestión de Clientes</h2>
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
                    <div class="relative w-full sm:w-1/2">
                        <input type="text" id="searchClientes" placeholder="Buscar por nombre, teléfono..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                    <button onclick="showClientForm()" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-user-plus mr-2"></i> Nuevo Cliente
                    </button>
                </div>
                <div id="clientesList" class="overflow-x-auto">
                    </div>
            </div>
        </div>

        <div id="viewEditarCita" class="view-section hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Editar Cita/Pedido <span id="editTicketNumberDisplay" class="text-indigo-600"></span></h2>
                <form id="formEditarCita">
                    <input type="hidden" id="ec_idCita" name="ID_Cita">
                    <input type="hidden" id="ec_idClienteFK" name="ID_Cliente_FK">

                    <div class="mb-6 border-b pb-4">
                        <h3 class="text-lg font-medium text-indigo-600 mb-3">Datos del Cliente</h3>
                        <p><strong>Nombre:</strong> <span id="ec_nombreClienteDisplay"></span></p>
                        <p><strong>Teléfono:</strong> <span id="ec_telefonoClienteDisplay"></span></p>
                        <p><strong>Dirección (Cita):</strong> <span id="ec_direccionClienteDisplay"></span></p>
                    </div>

                    <div class="mb-6 border-b pb-4">
                        <h3 class="text-lg font-medium text-indigo-600 mb-3">Información de la Cita</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="ec_tipoCita" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cita</label>
                                <select id="ec_tipoCita" name="Tipo_Cita" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" required>
                                    <option value="Recogida">Recogida</option>
                                    <option value="Entrega">Entrega</option>
                                </select>
                            </div>
                           <div>
                                <label for="ec_fechaHoraCita" class="block text-sm font-medium text-gray-700 mb-1">Fecha y Hora</label>
                                <input type="datetime-local" id="ec_fechaHoraCita" name="Fecha_Hora_Cita" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" required onchange="actualizarDiaSemana('ec_fechaHoraCita', 'ec_diaSemana')">
                                <span id="ec_diaSemana" class="text-sm text-gray-600 ml-2"></span> </div>
                        </div>
                        <div class="mt-4">
                            <label for="ec_direccionCita" class="block text-sm font-medium text-gray-700 mb-1">Dirección Cita (Maps)</label>
                            <input type="text" id="ec_direccionCita" name="Direccion_Cita" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="mt-4">
                            <label for="ec_articulosDescripcion" class="block text-sm font-medium text-gray-700 mb-1">Descripción General de Artículos</label>
                            <textarea id="ec_articulosDescripcion" name="Articulos_Descripcion" rows="3" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" required></textarea>
                        </div>
                         <div class="mt-4">
                             <label for="ec_servicioPostRecogida" class="block text-sm font-medium text-gray-700 mb-1">Servicio Post-Recogida</label>
                             <select id="ec_servicioPostRecogida" name="Servicio_PostRecogida" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- Seleccionar servicio --</option>
                                <option value="Limpiar y Entregar Directamente">Limpiar y Entregar Directamente</option>
                                <option value="Almacenar (avisar para limpieza/entrega)">Almacenar (avisar para limpieza/entrega)</option>
                                <option value="Solo Limpiar (cliente recoge)">Solo Limpiar (cliente recoge)</option>
                                <option value="Otro (detallar en notas)">Otro (detallar en notas)</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-6 border-b pb-6">
                        <h3 class="text-lg font-medium text-indigo-600 mb-3">Detalle de Artículos y Cálculo de Precio</h3>
                        <div class="mb-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Alfombras (8€/m²)</h4>
                            <div id="ec_alfombrasContainer"></div>
                            <button type="button" onclick="addAlfombraRow()" class="mt-2 text-sm bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg shadow hover:shadow-md transition-all">
                                <i class="fas fa-plus mr-1"></i> Añadir Alfombra
                            </button>
                        </div>
                        <div class="mb-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Edredones/Mantas/Colchas</h4>
                            <div id="ec_edredonesContainer"></div>
                            <button type="button" onclick="addEdredonRow()" class="mt-2 text-sm bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg shadow hover:shadow-md transition-all">
                                <i class="fas fa-plus mr-1"></i> Añadir Edredón/Manta
                            </button>
                        </div>
                        <div class="mt-4 p-4 bg-indigo-50 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-800">Total Calculado: <span id="ec_totalCalculado" class="text-indigo-700">0.00</span> €</h4>
                            <button type="button" onclick="usarTotalCalculado()" class="mt-2 text-sm bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:shadow-md transition-all">
                                Usar este total como Precio del Ticket
                            </button>
                        </div>
                        <input type="hidden" id="ec_detalleCalculoPrecio" name="Detalle_Calculo_Precio"> 
                    </div>
                    
                    <div class="mb-6">
                         <h3 class="text-lg font-medium text-indigo-600 mb-3">Finalizar Pedido</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                           <div>
                                <label for="ec_numeroTicket" class="block text-sm font-medium text-gray-700 mb-1">Número de Ticket</label>
                                <input type="text" id="ec_numeroTicket" name="Numero_Ticket" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100" readonly> 
                            </div>
                            <div>
                                <label for="ec_precioTicket" class="block text-sm font-medium text-gray-700 mb-1">Precio Ticket Final (€)</label>
                                <input type="number" step="0.01" id="ec_precioTicket" name="Precio_Ticket" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label for="ec_estadoPedido" class="block text-sm font-medium text-gray-700 mb-1">Estado del Pedido</label>
                                <select id="ec_estadoPedido" name="Estado_Pedido" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" required>
                                    <option value="Pendiente Recogida">Pendiente Recogida</option>
                                    <option value="Recogido/En Taller/Presupuesto">Recogido/En Taller/Presupuesto</option>
                                    <option value="En Almacén (Pendiente Limpieza)">En Almacén (Pendiente Limpieza)</option>
                                    <option value="Listo para Entrega">Listo para Entrega</option>
                                    <option value="Entregado">Entregado</option>
                                    <option value="Cancelado">Cancelado</option>
                                    <option value="Medido/Precio Calculado">Medido/Precio Calculado</option>
                                    <option value="En Taller Limpio">En Taller Limpio</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="ec_ubicacionAlmacen" class="block text-sm font-medium text-gray-700 mb-1">Ubicación en Almacén Cliente (Opcional)</label>
                            <input type="text" id="ec_ubicacionAlmacen" name="Ubicacion_Almacen_Cliente" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="mt-4">
                            <label for="ec_notasCita" class="block text-sm font-medium text-gray-700 mb-1">Notas Adicionales (Opcional)</label>
                            <textarea id="ec_notasCita" name="Notas_Cita" rows="3" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-8">
                        <button type="button" onclick="showView('viewCitas')" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out">
                            Cancelar
                        </button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105">
                            <i class="fas fa-save mr-2"></i> Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <nav class="bg-white shadow-t sticky bottom-0 z-50 border-t border-gray-200">
        <div class="container mx-auto flex justify-around">
            <button onclick="showView('viewCitas')" id="navCitas" class="nav-button active flex-1 text-gray-700 hover:bg-indigo-100 p-3 text-center">
                <i class="fas fa-list-alt block text-xl mb-1"></i>
                <span class="text-xs block">Citas</span>
            </button>
            <button onclick="showView('viewNuevaCita')" id="navNuevaCita" class="nav-button flex-1 text-gray-700 hover:bg-indigo-100 p-3 text-center">
                <i class="fas fa-plus-circle block text-xl mb-1"></i>
                <span class="text-xs block">Nueva</span>
            </button>
            <button onclick="showView('viewClientes')" id="navClientes" class="nav-button flex-1 text-gray-700 hover:bg-indigo-100 p-3 text-center">
                <i class="fas fa-users block text-xl mb-1"></i>
                <span class="text-xs block">Clientes</span>
            </button>
        </div>
    </nav>

    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('notificationModal')">&times;</span>
            <p id="notificationMessage" class="text-gray-700"></p>
            <div class="mt-4 text-right">
                 <button onclick="closeModal('notificationModal')" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">Aceptar</button>
            </div>
        </div>
    </div>
    
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3 id="confirmTitle" class="text-lg font-semibold mb-3 text-gray-800">Confirmación</h3>
            <p id="confirmMessage" class="text-gray-700"></p>
            <div class="mt-6 flex justify-end gap-3">
                <button id="confirmCancelButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirmOkButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="clientFormModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('clientFormModal')">&times;</span>
            <h3 id="clientFormTitle" class="text-xl font-semibold mb-4 text-gray-800">Nuevo Cliente</h3>
            <form id="formNuevoClienteModal">
                <div class="mb-4">
                    <label for="mf_nombreCliente" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                    <input type="text" id="mf_nombreCliente" name="Nombre" required> </div>
                <div class="mb-4">
                    <label for="mf_telefonoCliente" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                    <input type="tel" id="mf_telefonoCliente" name="Telefono" required> </div>
                <div class="mb-4">
                    <label for="mf_direccionCliente" class="block text-sm font-medium text-gray-700 mb-1">Dirección (Opcional)</label>
                    <input type="text" id="mf_direccionCliente" name="Direccion"> </div>
                <div class="mb-4">
                    <label for="mf_emailCliente" class="block text-sm font-medium text-gray-700 mb-1">Email (Opcional)</label>
                    <input type="email" id="mf_emailCliente" name="Email"> </div>
                <div class="mb-4">
                    <label for="mf_notasCliente" class="block text-sm font-medium text-gray-700 mb-1">Notas (Opcional)</label>
                    <textarea id="mf_notasCliente" name="Notas_Cliente" rows="2"></textarea> </div>
                <input type="hidden" id="mf_idCliente" name="ID_Cliente"> 
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('clientFormModal')" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">Guardar Cliente</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        console.log("Script principal cargado y parseado. v1.7"); 

        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzXIW4KV56Ia2ynHN3yTEekoG5a4cK-kcywe_9QRwo426fSbqboh9uA_7a-d8sMTpQq/exec'; // Reemplaza con tu URL
        const PRECIO_METRO_CUADRADO_ALFOMBRA = 8;
        const PRECIOS_EDREDONES = {
            "Pequeño Sintético": 16,
            "Grande Sintético": 18,
            "Pequeño Plumas": 20,
            "Grande Plumas": 22
        };

        const views = ['viewCitas', 'viewNuevaCita', 'viewClientes', 'viewEditarCita'];
        const navButtons = {
            'viewCitas': 'navCitas',
            'viewNuevaCita': 'navNuevaCita',
            'viewClientes': 'navClientes',
            'viewEditarCita': null 
        };

        function showView(viewId) {
            console.log(`showView INICIO - viewId: ${viewId}`);
            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (id === viewId) {
                        el.classList.remove('hidden');
                        el.classList.add('view-transition');
                    } else {
                        el.classList.add('hidden');
                    }
                } else {
                    console.error(`showView: Elemento con ID '${id}' no encontrado.`);
                }
            });
            Object.values(navButtons).forEach(navId => {
                if(navId) {
                    const btn = document.getElementById(navId);
                    if (btn) btn.classList.remove('active');
                }
            });
            if (navButtons[viewId]) {
                 const activeBtn = document.getElementById(navButtons[viewId]);
                 if (activeBtn) activeBtn.classList.add('active');
            }
            window.scrollTo(0, 0);

            if (viewId === 'viewCitas') {
                loadCitas(); 
            } else if (viewId === 'viewClientes') {
                loadClientes(); 
            } else if (viewId === 'viewNuevaCita') {
                document.getElementById('formNuevaCita').reset();
                clearClienteEncontrado(); // Limpiar datos de cliente anterior
                document.getElementById('nc_idCliente').value = ''; 
                suggestNumeroTicket('nc_numeroTicket');
                 // Habilitar campos de cliente por si estaban deshabilitados
                document.getElementById('nc_nombreCliente').disabled = false;
                document.getElementById('nc_direccionCita').disabled = false; // Asumimos que la dirección de la cita siempre es editable
                document.getElementById('nc_emailCliente').disabled = false;
                document.getElementById('nc_notasCliente').disabled = false;
            }
            console.log(`showView FIN - viewId: ${viewId}`);
        }
        
        function showModal(modalId, message, title) {
            // ... (código existente de showModal)
            console.log(`showModal llamada con modalId: ${modalId}`);
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error(`showModal: Modal con ID '${modalId}' no encontrado.`);
                return;
            }

            if (modalId === 'notificationModal') {
                const msgEl = document.getElementById('notificationMessage');
                if (msgEl) msgEl.textContent = message; else console.error("showModal: Elemento notificationMessage no encontrado");
            } else if (modalId === 'confirmModal') {
                const confirmMsgEl = document.getElementById('confirmMessage');
                if (confirmMsgEl) confirmMsgEl.textContent = message; else console.error("showModal: Elemento confirmMessage no encontrado");
                if (title) {
                    const confirmTitleEl = document.getElementById('confirmTitle');
                    if (confirmTitleEl) confirmTitleEl.textContent = title; else console.error("showModal: Elemento confirmTitle no encontrado");
                }
            }
            modal.style.display = "block";
        }

        function closeModal(modalId) {
            // ... (código existente de closeModal)
            console.log(`closeModal llamada con modalId: ${modalId}`);
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = "none";
            else console.error(`closeModal: Modal con ID '${modalId}' no encontrado al intentar cerrar.`);
        }

        function showConfirm(message, onOk, title = "Confirmar Acción") {
            // ... (código existente de showConfirm)
             console.log(`showConfirm llamada con mensaje: ${message}`);
            const confirmModal = document.getElementById('confirmModal');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmTitleEl = document.getElementById('confirmTitle');
            const okButton = document.getElementById('confirmOkButton');
            const cancelButton = document.getElementById('confirmCancelButton');

            if (!confirmModal || !confirmMessage || !confirmTitleEl || !okButton || !cancelButton) {
                console.error("showConfirm: Uno o más elementos del modal de confirmación no fueron encontrados.");
                return;
            }

            confirmMessage.textContent = message;
            confirmTitleEl.textContent = title;

            const newOkButton = okButton.cloneNode(true);
            okButton.parentNode.replaceChild(newOkButton, okButton);
            
            const newCancelButton = cancelButton.cloneNode(true);
            cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);

            newOkButton.addEventListener('click', () => {
                closeModal('confirmModal');
                if (onOk && typeof onOk === 'function') {
                    onOk();
                }
            });
            newCancelButton.addEventListener('click', () => closeModal('confirmModal'));
            
            confirmModal.style.display = 'block';
        }

        function showClientForm(clientId = null) { 
            // ... (código existente de showClientForm)
            console.log(`showClientForm llamada con clientId: ${clientId}`);
            const modal = document.getElementById('clientFormModal');
            const form = document.getElementById('formNuevoClienteModal');
            const title = document.getElementById('clientFormTitle');

            if (!modal || !form || !title) {
                console.error("showClientForm: Elementos del modal de cliente no encontrados.");
                return;
            }

            form.reset(); 
            const idField = document.getElementById('mf_idCliente');
            if (idField) idField.value = ''; else console.error("showClientForm: Campo mf_idCliente no encontrado.");

            if (clientId) {
                title.textContent = 'Editar Cliente';
                // TODO: Cargar datos del cliente y popular el formulario
                showModal('notificationModal', 'La edición de clientes se implementará pronto.');
                return; 
            } else {
                title.textContent = 'Nuevo Cliente';
            }
            modal.style.display = 'block';
        }

        function suggestNumeroTicket(elementId) {
            // ... (código existente de suggestNumeroTicket)
            console.log(`suggestNumeroTicket llamada para elementId: ${elementId}`);
            const el = document.getElementById(elementId);
            if (!el) {
                console.error(`suggestNumeroTicket: Elemento '${elementId}' para número de ticket no encontrado.`);
                return;
            }
            // Llama al backend para obtener el siguiente número sugerido
            fetch(`${SCRIPT_URL}?action=getNextTicketNumber`)
                .then(response => response.json())
                .then(result => {
                    if (result && result.ticketNumber) {
                        el.value = result.ticketNumber;
                    } else {
                        // Fallback a la lógica anterior si falla el backend
                        const yearDigit = new Date().getFullYear().toString().slice(-1); 
                        const randomSuffix = Math.floor(Math.random() * 900) + 100; 
                        el.value = yearDigit + randomSuffix.toString().padStart(3, '0');
                        console.warn("suggestNumeroTicket: No se pudo obtener el número del backend, usando fallback.");
                    }
                })
                .catch(error => {
                    console.error('Error al obtener siguiente número de ticket:', error);
                    const yearDigit = new Date().getFullYear().toString().slice(-1); 
                    const randomSuffix = Math.floor(Math.random() * 900) + 100; 
                    el.value = yearDigit + randomSuffix.toString().padStart(3, '0');
                });
        }
        
        let alfombraCounter = 0;
        let edredonCounter = 0;

        function addAlfombraRow(data = { largo: '', ancho: ''}) {
            // ... (código existente de addAlfombraRow)
            console.log("addAlfombraRow llamada con data:", data);
            alfombraCounter++;
            const container = document.getElementById('ec_alfombrasContainer');
            if (!container) { console.error("addAlfombraRow: Contenedor ec_alfombrasContainer no encontrado."); return; }

            const div = document.createElement('div');
            div.classList.add('grid', 'grid-cols-4', 'gap-2', 'mb-2', 'items-center');
            div.innerHTML = `
                <input type="number" placeholder="Largo (cm)" value="${data.largo}" class="col-span-1 p-2 border rounded-md shadow-sm" name="alfombra_largo_${alfombraCounter}" oninput="calculateAllPrices()">
                <input type="number" placeholder="Ancho (cm)" value="${data.ancho}" class="col-span-1 p-2 border rounded-md shadow-sm" name="alfombra_ancho_${alfombraCounter}" oninput="calculateAllPrices()">
                <span class="col-span-1 text-sm text-gray-700">Precio: <span id="precio_alfombra_${alfombraCounter}">0.00</span> €</span>
                <button type="button" class="col-span-1 bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded-md" onclick="removePriceItem(this);"><i class="fas fa-trash-alt"></i></button>
            `;
            container.appendChild(div);
            if (data.largo || data.ancho) calculateAllPrices(); 
        }

        function addEdredonRow(data = { tipo: ''}) {
            // ... (código existente de addEdredonRow)
            console.log("addEdredonRow llamada con data:", data);
            edredonCounter++;
            const container = document.getElementById('ec_edredonesContainer');
            if (!container) { console.error("addEdredonRow: Contenedor ec_edredonesContainer no encontrado."); return; }
            
            const div = document.createElement('div');
            div.classList.add('grid', 'grid-cols-4', 'gap-2', 'mb-2', 'items-center');
            
            let optionsHtml = '';
            for (const tipo in PRECIOS_EDREDONES) {
                optionsHtml += `<option value="${tipo}" ${data.tipo === tipo ? 'selected' : ''}>${tipo} (${PRECIOS_EDREDONES[tipo]}€)</option>`;
            }

            div.innerHTML = `
                <select class="col-span-2 p-2 border rounded-md shadow-sm" name="edredon_tipo_${edredonCounter}" onchange="calculateAllPrices()">
                    <option value="">Seleccionar tipo...</option>
                    ${optionsHtml}
                </select>
                <span class="col-span-1 text-sm text-gray-700">Precio: <span id="precio_edredon_${edredonCounter}">0.00</span> €</span>
                <button type="button" class="col-span-1 bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded-md" onclick="removePriceItem(this);"><i class="fas fa-trash-alt"></i></button>
            `;
            container.appendChild(div);
            if (data.tipo) calculateAllPrices();
        }
        
        function removePriceItem(button) {
            // ... (código existente de removePriceItem)
            console.log("removePriceItem llamado");
            button.closest('.grid').remove();
            calculateAllPrices(); 
        }

        function calculateAllPrices() {
            // ... (código existente de calculateAllPrices)
            console.log("calculateAllPrices INICIO");
            let totalGeneral = 0;
            let detalleCalculo = { alfombras: [], edredones: [], total: 0 };

            const alfombrasRows = document.querySelectorAll('#ec_alfombrasContainer .grid');
            alfombrasRows.forEach(row => {
                const largoInput = row.querySelector('input[name^="alfombra_largo_"]');
                const anchoInput = row.querySelector('input[name^="alfombra_ancho_"]');
                const precioSpan = row.querySelector('span[id^="precio_alfombra_"]');
                
                const largoCm = parseFloat(largoInput.value) || 0;
                const anchoCm = parseFloat(anchoInput.value) || 0;

                if (largoCm > 0 && anchoCm > 0) {
                    const areaM2 = (largoCm / 100) * (anchoCm / 100);
                    const precioAlfombra = areaM2 * PRECIO_METRO_CUADRADO_ALFOMBRA;
                    if(precioSpan) precioSpan.textContent = precioAlfombra.toFixed(2);
                    totalGeneral += precioAlfombra;
                    detalleCalculo.alfombras.push({largoCm, anchoCm, areaM2: areaM2.toFixed(2), precio: precioAlfombra.toFixed(2)});
                } else {
                    if(precioSpan) precioSpan.textContent = "0.00";
                }
            });

            const edredonesRows = document.querySelectorAll('#ec_edredonesContainer .grid');
            edredonesRows.forEach(row => {
                const tipoSelect = row.querySelector('select[name^="edredon_tipo_"]');
                const precioSpan = row.querySelector('span[id^="precio_edredon_"]');
                const tipoSeleccionado = tipoSelect.value;

                if (tipoSeleccionado && PRECIOS_EDREDONES[tipoSeleccionado]) {
                    const precioEdredon = PRECIOS_EDREDONES[tipoSeleccionado];
                    if(precioSpan) precioSpan.textContent = precioEdredon.toFixed(2);
                    totalGeneral += precioEdredon;
                    detalleCalculo.edredones.push({tipo: tipoSeleccionado, precio: precioEdredon.toFixed(2)});
                } else {
                    if(precioSpan) precioSpan.textContent = "0.00";
                }
            });
            const totalCalculadoEl = document.getElementById('ec_totalCalculado');
            if (totalCalculadoEl) totalCalculadoEl.textContent = totalGeneral.toFixed(2);
            else console.error("calculateAllPrices: Elemento ec_totalCalculado no encontrado.");

            detalleCalculo.total = totalGeneral.toFixed(2);
            const detallePrecioEl = document.getElementById('ec_detalleCalculoPrecio');
            if (detallePrecioEl) detallePrecioEl.value = JSON.stringify(detalleCalculo);
            else console.error("calculateAllPrices: Elemento ec_detalleCalculoPrecio no encontrado.");
            console.log("calculateAllPrices FIN");
        }

        function usarTotalCalculado() {
            // ... (código existente de usarTotalCalculado)
            console.log("usarTotalCalculado llamado");
            const totalCalculadoEl = document.getElementById('ec_totalCalculado');
            const precioTicketEl = document.getElementById('ec_precioTicket');

            if (!totalCalculadoEl) {console.error("usarTotalCalculado: Elemento ec_totalCalculado no encontrado."); return;}
            if (!precioTicketEl) {console.error("usarTotalCalculado: Elemento ec_precioTicket no encontrado."); return;}
            
            precioTicketEl.value = parseFloat(totalCalculadoEl.textContent).toFixed(2);
        }
        
        function fillEditForm(cita) {
            // ... (código existente de fillEditForm)
            console.log("fillEditForm INICIO - cita:", cita);
            
            const nombreClienteDisplay = document.getElementById('ec_nombreClienteDisplay');
            if(nombreClienteDisplay) nombreClienteDisplay.textContent = cita.Nombre_Cliente || 'N/A'; else console.warn("fillEditForm: ec_nombreClienteDisplay no encontrado");
            
            const telefonoClienteDisplay = document.getElementById('ec_telefonoClienteDisplay');
            if(telefonoClienteDisplay) telefonoClienteDisplay.textContent = cita.Telefono_Cliente || 'N/A'; else console.warn("fillEditForm: ec_telefonoClienteDisplay no encontrado");

            const direccionClienteDisplay = document.getElementById('ec_direccionClienteDisplay');
            if(direccionClienteDisplay) direccionClienteDisplay.textContent = cita.Direccion_Cita || 'N/A'; else console.warn("fillEditForm: ec_direccionClienteDisplay no encontrado");


            const citaToFieldMap = {
                ID_Cita: 'ec_idCita', ID_Cliente_FK: 'ec_idClienteFK', Tipo_Cita: 'ec_tipoCita', 
                Fecha_Hora_Cita: 'ec_fechaHoraCita', Direccion_Cita: 'ec_direccionCita', 
                Articulos_Descripcion: 'ec_articulosDescripcion', Servicio_PostRecogida: 'ec_servicioPostRecogida',
                Numero_Ticket: 'ec_numeroTicket', Precio_Ticket: 'ec_precioTicket', Estado_Pedido: 'ec_estadoPedido',
                Ubicacion_Almacen_Cliente: 'ec_ubicacionAlmacen', Notas_Cita: 'ec_notasCita'
            };
            
            for (const key in citaToFieldMap) {
                const elementId = citaToFieldMap[key];
                const element = document.getElementById(elementId);
                if (element) {
                    if (key === 'Fecha_Hora_Cita') {
                        element.value = cita[key] ? cita[key].substring(0, 16) : '';
                    } else {
                        element.value = cita[key] || '';
                    }
                } else {
                    console.warn(`fillEditForm: Elemento con ID '${elementId}' no encontrado.`);
                }
            }
            const ticketNumDisplay = document.getElementById('editTicketNumberDisplay');
            if (ticketNumDisplay) ticketNumDisplay.textContent = `#${cita.Numero_Ticket}`; 
            else console.warn("fillEditForm: editTicketNumberDisplay no encontrado.");

            const alfombrasContainer = document.getElementById('ec_alfombrasContainer');
            if (alfombrasContainer) alfombrasContainer.innerHTML = ''; else console.warn("fillEditForm: ec_alfombrasContainer no encontrado.");
            const edredonesContainer = document.getElementById('ec_edredonesContainer');
            if (edredonesContainer) edredonesContainer.innerHTML = ''; else console.warn("fillEditForm: ec_edredonesContainer no encontrado.");
            
            alfombraCounter = 0; 
            edredonCounter = 0;

            if (cita.Detalle_Calculo_Precio) {
                try {
                    const detalle = JSON.parse(cita.Detalle_Calculo_Precio);
                    if (detalle.alfombras && Array.isArray(detalle.alfombras)) {
                        detalle.alfombras.forEach(alf => addAlfombraRow({ largo: alf.largoCm, ancho: alf.anchoCm }));
                    }
                    if (detalle.edredones && Array.isArray(detalle.edredones)) {
                        detalle.edredones.forEach(edr => addEdredonRow({ tipo: edr.tipo }));
                    }
                } catch (e) {
                    console.error("fillEditForm: Error parseando Detalle_Calculo_Precio:", e, cita.Detalle_Calculo_Precio);
                }
            }
            calculateAllPrices(); 
            showView('viewEditarCita');
            console.log("fillEditForm FIN");
        }

        async function loadCitas() {
            // ... (código existente de loadCitas con simulación)
            // TODO: Reemplazar con fetch al backend
            console.log("loadCitas INICIO (simulación)");
            const citasLugar = document.getElementById('citasList');
            if (!citasLugar) { console.error("loadCitas: Elemento 'citasList' NO encontrado."); return; }
            citasLugar.innerHTML = '<p class="text-gray-500 text-center py-4">Cargando citas reales...</p>';

            try {
                const response = await fetch(`${SCRIPT_URL}?action=getCitas`);
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const citas = await response.json();

                if (citas && citas.length > 0) {
                    citasLugar.innerHTML = citas.map(cita => `
                        <div class="bg-gray-50 p-4 rounded-lg shadow mb-3 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-semibold text-indigo-600">${cita.Nombre_Cliente || 'Cliente Desconocido'}</h3>
                                <span class="text-sm text-gray-500">Ticket: #${cita.Numero_Ticket || 'S/N'}</span>
                            </div>
                            <p class="text-sm text-gray-700"><i class="fas fa-calendar-alt mr-2"></i>Fecha: ${cita.Fecha_Hora_Cita ? new Date(cita.Fecha_Hora_Cita).toLocaleString('es-ES', {dateStyle:'short', timeStyle:'short'}) : 'N/A'}</p>
                            <p class="text-sm text-gray-700"><i class="fas fa-info-circle mr-2"></i>Tipo: ${cita.Tipo_Cita || 'N/A'}</p>
                            <p class="text-sm text-gray-700"><i class="fas fa-flag mr-2"></i>Estado: <span class="font-medium text-blue-500">${cita.Estado_Pedido || 'N/A'}</span></p>
                            <div class="mt-3 flex justify-end gap-2">
                                <button onclick="editCitaPlaceholder('${cita.ID_Cita}')" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg text-sm shadow hover:shadow-md transition-all">
                                    <i class="fas fa-eye mr-1"></i> Ver/Editar
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    citasLugar.innerHTML = '<p class="text-gray-600 text-center py-4">No hay citas registradas.</p>';
                }
            } catch (error) {
                console.error('Error al cargar citas:', error);
                citasLugar.innerHTML = `<p class="text-red-500 text-center py-4">Error al cargar citas: ${error.message}</p>`;
            }
            console.log("loadCitas FIN");
        }

        async function loadClientes() {
            // ... (código existente de loadClientes con simulación)
            // TODO: Reemplazar con fetch al backend
             console.log("loadClientes INICIO (simulación)");
            const clientesList = document.getElementById('clientesList');
            if (!clientesList) { console.error("loadClientes: Elemento clientesList no encontrado."); return; }
            clientesList.innerHTML = '<p class="text-gray-500 text-center py-4">Cargando clientes reales...</p>';
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getClientes`);
                 if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const clientes = await response.json();

                if (clientes && clientes.length > 0) {
                    clientesList.innerHTML = clientes.map(cliente => `
                        <div class="bg-gray-50 p-4 rounded-lg shadow mb-3">
                            <h3 class="text-lg font-semibold text-indigo-600">${cliente.Nombre || 'N/A'}</h3>
                            <p class="text-sm text-gray-700"><i class="fas fa-phone mr-2"></i>${cliente.Telefono || 'N/A'}</p>
                            <p class="text-sm text-gray-700"><i class="fas fa-map-marker-alt mr-2"></i>${cliente.Direccion || 'N/A'}</p>
                            <div class="mt-2 flex justify-end gap-2">
                                 <button onclick="showClientForm('${cliente.ID_Cliente}')" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-lg text-xs">Editar</button>
                                 <button onclick="prepararNuevaCitaConCliente('${cliente.ID_Cliente}')" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded-lg text-xs">Nueva Cita</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    clientesList.innerHTML = '<p class="text-gray-600 text-center py-4">No hay clientes registrados.</p>';
                }
            } catch (error) {
                console.error('Error al cargar clientes:', error);
                clientesList.innerHTML = `<p class="text-red-500 text-center py-4">Error al cargar clientes: ${error.message}</p>`;
            }
            console.log("loadClientes FIN");
        }

        function prepararNuevaCitaConCliente(clienteId) {
            console.log(`Preparando nueva cita para cliente ID: ${clienteId}`);
            // Lógica para buscar el cliente por ID y rellenar el formulario de nueva cita
            fetch(`${SCRIPT_URL}?action=getClienteById&id=${clienteId}`)
                .then(response => response.json())
                .then(cliente => {
                    if (cliente && cliente.ID_Cliente) {
                        showView('viewNuevaCita'); // Cambia a la vista de nueva cita
                        // Rellena los campos del cliente en el formulario de nueva cita
                        document.getElementById('nc_telefonoCliente').value = cliente.Telefono || '';
                        document.getElementById('nc_nombreCliente').value = cliente.Nombre || '';
                        // La dirección de la cita puede ser diferente a la del cliente, así que no la autocompletamos directamente aquí,
                        // o podríamos poner la del cliente como sugerencia. Por ahora, la dejamos para que el usuario la introduzca.
                        // document.getElementById('nc_direccionCita').value = cliente.Direccion || ''; 
                        document.getElementById('nc_emailCliente').value = cliente.Email || '';
                        document.getElementById('nc_notasCliente').value = cliente.Notas_Cliente || '';
                        document.getElementById('nc_idCliente').value = cliente.ID_Cliente; // Muy importante: ID_Cliente_FK

                        // Deshabilitar campos del cliente para evitar edición accidental aquí
                        document.getElementById('nc_nombreCliente').disabled = true;
                        document.getElementById('nc_emailCliente').disabled = true;
                        document.getElementById('nc_notasCliente').disabled = true;
                        document.getElementById('clienteEncontradoMsg').textContent = `Cliente encontrado: ${cliente.Nombre}. Datos autocompletados.`;

                    } else {
                        showModal('notificationModal', 'Error: No se pudo encontrar el cliente seleccionado.');
                    }
                })
                .catch(error => {
                    console.error('Error al obtener datos del cliente para nueva cita:', error);
                    showModal('notificationModal', `Error al cargar datos del cliente: ${error.message}`);
                });
        }

        function clearClienteEncontrado() {
            document.getElementById('clienteEncontradoMsg').textContent = '';
            // Habilitar campos de cliente
            document.getElementById('nc_nombreCliente').disabled = false;
            // document.getElementById('nc_direccionCita').disabled = false; // Dirección de la cita siempre editable
            document.getElementById('nc_emailCliente').disabled = false;
            document.getElementById('nc_notasCliente').disabled = false;
        }


        async function buscarClientePorTelefono(telefono) {
            if (!telefono || telefono.trim() === '') {
                clearClienteEncontrado();
                document.getElementById('nc_idCliente').value = ''; // Limpiar ID si el teléfono está vacío
                return;
            }
            console.log(`Buscando cliente por teléfono: ${telefono}`);
            const msgDiv = document.getElementById('clienteEncontradoMsg');
            msgDiv.textContent = 'Buscando cliente...';

            try {
                const response = await fetch(`${SCRIPT_URL}?action=getClienteByTelefono&telefono=${encodeURIComponent(telefono)}`);
                if (!response.ok) {
                     // Si el backend devuelve un error específico (ej. 404 Not Found), lo manejamos como cliente no encontrado
                    if (response.status === 404 || response.status === 500) { // Asumiendo que el backend puede devolver 404 o un error si no encuentra
                         console.log("Cliente no encontrado por teléfono, o error del backend.");
                         msgDiv.textContent = 'Cliente no encontrado. Puede crear uno nuevo.';
                         document.getElementById('nc_nombreCliente').value = '';
                         // document.getElementById('nc_direccionCita').value = ''; // La dirección de la cita es independiente
                         document.getElementById('nc_emailCliente').value = '';
                         document.getElementById('nc_notasCliente').value = '';
                         document.getElementById('nc_idCliente').value = ''; // Asegurar que no hay ID de cliente
                         clearClienteEncontrado(); // Habilitar campos
                         return;
                    }
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const cliente = await response.json();

                if (cliente && cliente.ID_Cliente) {
                    console.log("Cliente encontrado:", cliente);
                    msgDiv.textContent = `Cliente encontrado: ${cliente.Nombre}. Datos autocompletados.`;
                    document.getElementById('nc_nombreCliente').value = cliente.Nombre || '';
                    // No autocompletar nc_direccionCita con cliente.Direccion, ya que es la dirección del servicio.
                    // Si se quisiera la dirección del cliente como default, se podría hacer aquí.
                    document.getElementById('nc_emailCliente').value = cliente.Email || '';
                    document.getElementById('nc_notasCliente').value = cliente.Notas_Cliente || '';
                    document.getElementById('nc_idCliente').value = cliente.ID_Cliente; // Guardar el ID del cliente encontrado

                    // Opcional: deshabilitar campos autocompletados para evitar edición accidental
                    document.getElementById('nc_nombreCliente').disabled = true;
                    document.getElementById('nc_emailCliente').disabled = true;
                    document.getElementById('nc_notasCliente').disabled = true;

                } else {
                    console.log("Cliente no encontrado por teléfono.");
                    msgDiv.textContent = 'Cliente no encontrado. Puede crear uno nuevo rellenando los campos.';
                    document.getElementById('nc_nombreCliente').value = '';
                    // document.getElementById('nc_direccionCita').value = ''; // Dirección de la cita es independiente
                    document.getElementById('nc_emailCliente').value = '';
                    document.getElementById('nc_notasCliente').value = '';
                    document.getElementById('nc_idCliente').value = ''; // Asegurar que no hay ID de cliente
                    clearClienteEncontrado(); // Habilitar campos
                }
            } catch (error) {
                console.error('Error al buscar cliente por teléfono:', error);
                msgDiv.textContent = `Error al buscar cliente: ${error.message}`;
                clearClienteEncontrado();
                document.getElementById('nc_idCliente').value = '';
            }
        }
        
        function editCitaPlaceholder(citaId) {
            // ... (código existente de editCitaPlaceholder)
            // TODO: Reemplazar con fetch al backend para obtener datos de la cita por ID y luego llamar a fillEditForm
            console.log(`editCitaPlaceholder llamada con citaId: ${citaId}`);
             showModal('notificationModal', 'Cargando datos de la cita para editar...');
            fetch(`${SCRIPT_URL}?action=getCitaById&id=${citaId}`)
                .then(response => {
                    if (!response.ok) throw new Error(`Error HTTP al cargar cita: ${response.status}`);
                    return response.json();
                })
                .then(cita => {
                    if (cita && cita.ID_Cita) {
                        fillEditForm(cita);
                        closeModal('notificationModal');
                    } else {
                        throw new Error(cita.error || 'No se encontraron datos para la cita seleccionada.');
                    }
                })
                .catch(error => {
                    console.error('Error al cargar datos de la cita para editar:', error);
                    showModal('notificationModal', `Error al cargar cita: ${error.message}`);
                });
        }

	function actualizarDiaSemana(inputId, displayId) {
    		const inputElement = document.getElementById(inputId);
    		const displayElement = document.getElementById(displayId);
    		if (!inputElement || !displayElement) {
        	console.error("Elementos de fecha o display de día no encontrados. InputID:", inputId, "DisplayID:", displayId);
        	return;
    }

   		 const fechaValor = inputElement.value;
   	 if (fechaValor) {
       		 try {
            // datetime-local devuelve un string como "YYYY-MM-DDTHH:mm"
            const fechaObj = new Date(fechaValor.replace('T', ' ')); 
            if (isNaN(fechaObj.getTime())) { // Comprobación más robusta de fecha inválida
                 displayElement.textContent = ""; 
                 // console.warn("Fecha inválida o incompleta:", fechaValor); // Puedes descomentar esto para depurar
                 return;
            }
            const opciones = { weekday: 'long' }; 
            let diaSemana = new Intl.DateTimeFormat('es-ES', opciones).format(fechaObj);
            diaSemana = diaSemana.charAt(0).toUpperCase() + diaSemana.slice(1);
            displayElement.textContent = diaSemana;
        } catch (e) {
            console.error("Error al formatear la fecha para obtener el día de la semana:", e);
            displayElement.textContent = ""; 
        }
    } else {
        displayElement.textContent = ""; 
    }
}

        // --- Event Listeners y Ejecución Inicial ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded: Evento disparado. v1.7");
            
            showView('viewCitas'); 

            // Formulario Nueva Cita
            const formNuevaCita = document.getElementById('formNuevaCita');
            if (formNuevaCita) {
                formNuevaCita.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    console.log("Formulario Nueva Cita - Intentando enviar al backend...");
                    
                    const formData = new FormData(this);
                    const citaData = Object.fromEntries(formData.entries());

                    // Asegurarse de que los campos de cliente deshabilitados se envíen si hay un ID_Cliente_FK
                    // (ya que FormData no recoge campos deshabilitados por defecto)
                    if (document.getElementById('nc_idCliente').value) {
                        citaData.Nombre_Cliente = document.getElementById('nc_nombreCliente').value;
                        citaData.Email = document.getElementById('nc_emailCliente').value; // Corresponde a Email del cliente
                        citaData.Notas_Cliente = document.getElementById('nc_notasCliente').value;
                    }


                    // El backend espera 'Nombre_Cliente' y 'Telefono_Cliente' para la cita,
                    // y también los datos del cliente si es nuevo.
                    // Los nombres de los campos del formulario ya deberían coincidir.

                    console.log("Datos a enviar para addCita:", citaData);

                    try {
                        showModal('notificationModal', 'Guardando nueva cita...');

                        const response = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json',},
                            body: JSON.stringify({ action: 'addCita', data: citaData }),
                        });

                        const result = await response.json();
                        console.log("Respuesta del backend (addCita):", result);

                        if (result.success && result.data && result.data.ID_Cita) {
                            showModal('notificationModal', `Cita guardada con éxito. Ticket: #${result.data.Numero_Ticket}`);
                            this.reset(); // Limpiar formulario
                            clearClienteEncontrado();
                            document.getElementById('nc_idCliente').value = '';
                            showView('viewCitas'); // Volver al panel de citas
                            loadCitas(); // Recargar la lista de citas
                        } else {
                            throw new Error(result.error || 'Error desconocido al guardar la cita.');
                        }
                    } catch (error) {
                        console.error('Error al guardar nueva cita:', error);
                        showModal('notificationModal', `Error al guardar cita: ${error.message}`);
                    }
                });
            } else {
                console.error("DOMContentLoaded: Formulario formNuevaCita no encontrado.");
            }
            
            // Formulario Editar Cita
            const formEditarCita = document.getElementById('formEditarCita');
            if(formEditarCita) {
                formEditarCita.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    console.log("Formulario Editar Cita - Intentando enviar al backend...");
                    
                    const formData = new FormData(this);
                    const citaData = Object.fromEntries(formData.entries());
                    citaData.Detalle_Calculo_Precio = document.getElementById('ec_detalleCalculoPrecio').value; // Asegurar que el detalle se envíe

                    console.log("Datos a enviar para updateCita:", citaData);

                     try {
                        showModal('notificationModal', 'Actualizando cita...');

                        const response = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json',},
                            body: JSON.stringify({ action: 'updateCita', data: citaData }),
                        });

                        const result = await response.json();
                        console.log("Respuesta del backend (updateCita):", result);

                        if (result.success && result.data && result.data.ID_Cita) {
                            showModal('notificationModal', `Cita actualizada con éxito. Ticket: #${result.data.Numero_Ticket}`);
                            showView('viewCitas'); 
                            loadCitas(); 
                        } else {
                            throw new Error(result.error || 'Error desconocido al actualizar la cita.');
                        }
                    } catch (error) {
                        console.error('Error al actualizar cita:', error);
                        showModal('notificationModal', `Error al actualizar cita: ${error.message}`);
                    }
                });
            } else {
                console.error("DOMContentLoaded: Formulario formEditarCita no encontrado.");
            }

            // Formulario Nuevo Cliente (Modal)
            const formNuevoClienteModal = document.getElementById('formNuevoClienteModal');
            if (formNuevoClienteModal) {
                formNuevoClienteModal.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    console.log("Formulario Nuevo Cliente (Modal) - Intentando enviar al backend...");

                    const formData = new FormData(this);
                    const clienteData = Object.fromEntries(formData.entries());
                    
                    console.log("Datos a enviar para addCliente (modal):", clienteData);

                    try {
                        showModal('notificationModal', 'Guardando cliente...');

                        const response = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json',},
                            body: JSON.stringify({action: 'addCliente', data: clienteData}),
                        });

                        const result = await response.json();
                        console.log("Respuesta del backend (addCliente modal):", result);

                        if (result.success && result.data && result.data.ID_Cliente) {
                            showModal('notificationModal', `Cliente guardado con éxito. ID: ${result.data.ID_Cliente}`);
                            closeModal('clientFormModal');
                            loadClientes(); 
                        } else {
                            throw new Error(result.error || 'Error desconocido al guardar el cliente.');
                        }
                    } catch (error) {
                        console.error('Error al guardar cliente (modal):', error);
                        showModal('notificationModal', `Error al guardar cliente: ${error.message}`);
                    }
                });
            } else {
                console.error("DOMContentLoaded: Formulario formNuevoClienteModal no encontrado.");
            }
        });

        window.onclick = function(event) {
            const notificationModal = document.getElementById('notificationModal');
            const confirmModal = document.getElementById('confirmModal');
            const clientFormModal = document.getElementById('clientFormModal');
            if (event.target == notificationModal) closeModal('notificationModal');
            if (event.target == confirmModal) closeModal('confirmModal');
            if (event.target == clientFormModal) closeModal('clientFormModal');
        }
    </script>
</body>
</html>


